<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, user-scalable=no" />
<title>Snake Game</title>
<link rel="icon" type="favicon.svg" href="/snake.svg" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Press+Start+2P&display=swap');

  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    font-family: 'Montserrat', sans-serif;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  #game-container {
    position: relative;
    width: 360px;
    height: 480px;
    border-radius: 20px;
    background: #111a2b;
    box-shadow:
      0 0 30px rgba(66, 135, 245, 0.7),
      inset 0 0 40px rgba(66, 135, 245, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    z-index: 1;
  }

  canvas {
    background: radial-gradient(circle at center, #0c1420 60%, #162b47 100%);
    border-radius: 15px;
    box-shadow:
      0 0 20px #3a6de0,
      inset 0 0 10px #1f3a80;
  }

  #scoreboard {
    margin-top: 12px;
    font-size: 20px;
    font-weight: 600;
    color: #62a0ff;
    user-select: none;
    letter-spacing: 1.2px;
    display: flex;
    justify-content: space-between;
    width: 100%;
    padding: 0 12px;
  }

  #instructions {
    margin-top: 8px;
    font-size: 10px;
    color: #8ab6f9cc;
    text-align: center;
    max-width: 340px;
    user-select: none;
  }

  /* Made by Adi corner text */
  #made-by-adi {
    position: fixed;
    top: 12px;
    right: 20px;
    font-family: 'Press Start 2P', cursive;
    font-size: 12px;
    color: #a5b8ffcc;
    user-select: none;
    pointer-events: none;
    letter-spacing: 2px;
    text-shadow: 0 0 5px #4169e1aa;
    z-index: 10;
  }

  /* Game Over Overlay */
  #game-over-screen {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(20, 29, 55, 0.95);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #f25c54;
    font-family: 'Press Start 2P', cursive;
    font-size: 24px;
    letter-spacing: 1.5px;
    text-shadow: 0 0 6px #ff5151bb;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.4s ease;
    user-select: none;
  }
  #game-over-screen.visible {
    visibility: visible;
    opacity: 1;
  }
  #game-over-score {
    margin-top: 12px;
    font-size: 18px;
    color: #ff8987;
  }
  #restart-btn {
    margin-top: 20px;
    background: #f25c54;
    border: none;
    padding: 12px 30px;
    border-radius: 30px;
    color: white;
    font-weight: 700;
    font-family: 'Montserrat', sans-serif;
    cursor: pointer;
    box-shadow: 0 0 15px #f25c54cc;
    transition: background-color 0.2s ease;
  }
  #restart-btn:hover {
    background: #ff312b;
  }
  #pause-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Press Start 2P', cursive;
    font-size: 28px;
    color: #5890ffdd;
    text-shadow: 0 0 8px #5890ffb0;
    user-select: none;
    pointer-events: none;
    display: none;
  }

  /* "Back to Menu" button */
  #back-to-menu-btn {
    position: fixed;
    top: 12px;
    left: 12px;
    background: #4a90e2;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    color: white;
    font-weight: 700;
    font-family: 'Montserrat', sans-serif;
    cursor: pointer;
    box-shadow: 0 0 12px #357abd;
    transition: background-color 0.3s ease;
    z-index: 10000;
  }
  #back-to-menu-btn:hover {
    background: #357abd;
  }

  /* Pop-up styles */
  #name-popup {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    visibility: visible;
    opacity: 1;
    transition: opacity 0.4s ease;
    z-index: 1000;
  }
  #name-popup.hidden {
    visibility: hidden;
    opacity: 0;
  }
  #name-popup-content {
    background: #141e37;
    color: #fff;
    padding: 30px 40px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 0 40px #446bf585;
    font-family: 'Montserrat', sans-serif;
  }
  #name-popup-content h2 {
    margin: 0 0 20px;
    font-weight: 600;
    letter-spacing: 1.2px;
    text-shadow: 0 0 5px #4a90e2;
  }
  #name-input {
    margin-top: 10px;
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    width: 250px;
    font-size: 1.1rem;
    text-align: center;
    outline: none;
  }
  #submit-name {
    margin-top: 20px;
    padding: 12px 40px;
    background: #4a90e2;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 1.1px;
    box-shadow: 0 0 20px #357abd;
    transition: background-color 0.25s ease;
  }
  #submit-name:hover {
    background: #357abd;
  }

  /* Starting Page */
  #start-page {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(20, 29, 55, 0.95);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 900;
    font-family: 'Montserrat', sans-serif;
  }
  #start-page.visible {
    visibility: visible;
    opacity: 1;
  }
  #start-page h1 {
    color: #62a0ff;
    font-weight: 700;
    font-size: 2.5rem;
    letter-spacing: 0.1rem;
    margin-bottom: 2rem;
    text-shadow: 0 0 18px #4a90e2;
  }
  #start-page button {
    margin: 12px 0;
    padding: 15px 50px;
    background: #4a90e2;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: 0.07rem;
    box-shadow: 0 0 22px #4a90e2;
    transition: background-color 0.3s ease;
    width: 220px;
  }
  #start-page button:hover {
    background: #357abd;
  }

  /* Leaderboard & Settings Overlay */
  #leaderboard, #settings {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #141e37;
    border-radius: 20px;
    padding: 30px 40px;
    box-shadow: 0 0 50px #446bf5bb;
    color: white;
    max-width: 320px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1100;
    display: none;
    font-family: 'Montserrat', sans-serif;
  }
  #leaderboard.visible, #settings.visible {
    display: block;
  }
  #leaderboard h2, #settings h2 {
    margin-top: 0;
    font-weight: 700;
    font-size: 1.5rem;
    letter-spacing: 0.05rem;
    margin-bottom: 20px;
    text-align: center;
    text-shadow: 0 0 7px #4a90e2;
  }
  #leaderboard ul {
    list-style: none;
    padding: 0;
    margin: 0 0 20px 0;
  }
  #leaderboard li {
    font-size: 1.1rem;
    padding: 6px 0;
    border-bottom: 1px solid #357abd44;
  }
  #leaderboard li:last-child {
    border-bottom: none;
  }
  #close-leaderboard, #close-settings {
    background: #4a90e2;
    border: none;
    padding: 12px 25px;
    border-radius: 20px;
    cursor: pointer;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    display: block;
    margin: 0 auto;
    box-shadow: 0 0 15px #357abd;
    transition: background-color 0.3s ease;
  }
  #close-leaderboard:hover, #close-settings:hover {
    background: #357abd;
  }
  #settings label {
    font-weight: 600;
    font-size: 1.1rem;
  }
  #name-change {
    margin-top: 8px;
    padding: 10px;
    border-radius: 10px;
    border: none;
    width: 100%;
    font-size: 1rem;
    text-align: center;
    outline: none;
  }
  #change-name-btn {
    margin-top: 15px;
    width: 100%;
    padding: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    background: #4a90e2;
    color: white;
    box-shadow: 0 0 20px #357abd;
    transition: background-color 0.3s ease;
  }
  #change-name-btn:hover {
    background: #357abd;
  }
  #change-skin {
    margin-top: 30px;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
  }
  .color-option {
    width: 38px;
    height: 38px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 0 8px transparent;
    border: 2px solid transparent;
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
  }
  .color-option:hover {
    box-shadow: 0 0 12px #4a90e2;
  }
  .color-option.selected {
    border-color: white;
    box-shadow: 0 0 20px #4a90e2;
  }

  /* Scrollbar styles for Settings and Leaderboard */
  #settings::-webkit-scrollbar, #leaderboard::-webkit-scrollbar {
    width: 8px;
  }
  #settings::-webkit-scrollbar-thumb, #leaderboard::-webkit-scrollbar-thumb {
    background-color: #4a90e2;
    border-radius: 10px;
  }
  #settings::-webkit-scrollbar-thumb:hover, #leaderboard::-webkit-scrollbar-thumb:hover {
    background-color: #357abd;
  }
  #settings::-webkit-scrollbar-track, #leaderboard::-webkit-scrollbar-track {
    background-color: #141e37;
  }
</style>
</head>
<body>

<!-- Name entry pop-up -->
<div id="name-popup" aria-modal="true" role="dialog" aria-labelledby="name-popup-label">
  <div id="name-popup-content">
    <h2 id="name-popup-label">Enter Your Name</h2>
    <input type="text" id="name-input" placeholder="Your Name" aria-label="Player name" />
    <button id="submit-name" aria-label="Submit Name">OK</button>
  </div>
</div>

<!-- Starting page -->
<div id="start-page" role="main" aria-hidden="true">
  <h1>Welcome to Snake Game</h1>
  <button id="start-btn" aria-label="Start Game">Start</button>
  <button id="leaderboard-btn" aria-label="Open Leaderboard">Leaderboard</button>
  <button id="settings-btn" aria-label="Open Settings">Settings</button>
</div>

<!-- Leaderboard overlay -->
<div id="leaderboard" role="dialog" aria-modal="true" aria-labelledby="leaderboard-label" aria-hidden="true">
  <h2 id="leaderboard-label">Leaderboard</h2>
  <ul id="leaderboard-list" aria-live="polite" aria-relevant="additions"></ul>
  <button id="close-leaderboard" aria-label="Close Leaderboard">Close</button>
</div>

<!-- Settings overlay -->
<div id="settings" role="dialog" aria-modal="true" aria-labelledby="settings-label" aria-hidden="true">
  <h2 id="settings-label">Settings</h2>
  <label for="name-change">Change Name:</label>
  <input type="text" id="name-change" placeholder="New Name" aria-label="Change player name" />
  <button id="change-name-btn" aria-label="Change Name">Change Name</button>
  <h3>Change Skin:</h3>
  <div id="change-skin" aria-label="Choose snake skin color"></div>
  <button id="close-settings" aria-label="Close Settings">Close</button>
</div>

<!-- The original game container -->
<div id="game-container" aria-hidden="true">
  <button id="back-to-menu-btn" aria-label="Back to Menu">Back to Menu</button>
  <canvas id="game" width="360" height="360" tabindex="0" aria-label="Game canvas"></canvas>
  <div id="scoreboard" role="region" aria-live="polite" aria-atomic="true">
    <div>Score: <span id="score">0</span></div>
    <div>Speed: <span id="speed">1</span></div>
  </div>
  <div id="instructions" aria-live="polite" aria-atomic="true">
    Use arrow keys or swipe to control.<br />
    Press SPACE to Pause/Resume.
  </div>
  <div id="pause-indicator">PAUSED</div>
  <div id="game-over-screen" aria-live="assertive" aria-atomic="true">
    GAME OVER
    <div id="game-over-score"></div>
    <button id="restart-btn">RESTART</button>
  </div>
</div>

<div id="made-by-adi">Made by Adi</div>

<script>
(() => {
  // Elements
  const namePopup = document.getElementById('name-popup');
  const nameInput = document.getElementById('name-input');
  const submitNameBtn = document.getElementById('submit-name');
  const startPage = document.getElementById('start-page');
  const startBtn = document.getElementById('start-btn');
  const leaderboardBtn = document.getElementById('leaderboard-btn');
  const settingsBtn = document.getElementById('settings-btn');
  const leaderboard = document.getElementById('leaderboard');
  const leaderboardList = document.getElementById('leaderboard-list');
  const closeLeaderboardBtn = document.getElementById('close-leaderboard');
  const settings = document.getElementById('settings');
  const nameChangeInput = document.getElementById('name-change');
  const changeNameBtn = document.getElementById('change-name-btn');
  const closeSettingsBtn = document.getElementById('close-settings');
  const changeSkinDiv = document.getElementById('change-skin');
  const gameContainer = document.getElementById('game-container');
  const backToMenuBtn = document.getElementById('back-to-menu-btn');

  // Game elements
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const speedEl = document.getElementById('speed');
  const gameOverScreen = document.getElementById('game-over-screen');
  const gameOverScore = document.getElementById('game-over-score');
  const restartBtn = document.getElementById('restart-btn');
  const pauseIndicator = document.getElementById('pause-indicator');

  // Constants
  const COLS = 18;
  const ROWS = 18;
  const CELL_SIZE = canvas.width / COLS;
  const DIRS = {
    LEFT:  { x: -1, y: 0 },
    RIGHT: { x: 1, y: 0 },
    UP:    { x: 0, y: -1 },
    DOWN:  { x: 0, y: 1 }
  };
  const colors = ['#FF5733', '#33FF57', '#3357FF', '#F1C40F', '#8E44AD', '#E74C3C', '#3498DB', '#2ECC71', '#1ABC9C', '#F39C12', '#D35400', '#C0392B', '#9B59B6', '#2980B9', '#27AE60', '#8E44AD', '#34495E', '#2C3E50', '#ECF0F1', '#95A5A6'];

  // Player data stored local
  let playerName = localStorage.getItem('snakePlayerName') || '';
  let playerSkinColor = localStorage.getItem('snakeSkinColor') || '#4b8bf5';
  let highestScore = +localStorage.getItem('snakeHighestScore') || 0;

  // Game state
  let snake = [{x:9, y:9}];
  let direction = DIRS.RIGHT;
  let nextDirection = direction;
  let food = null;
  let score = 0;
  let speed = 5; // moves per second base speed
  let speedLevel = 1;
  const maxSpeedLevel = 15;
  const speedIncrementScoreStep = 5;
  let lastMoveTime = 0;
  let gameOver = false;
  let paused = false;
  let moveProgress = 0;
  let lastHeadPos = { x: 9, y: 9 };
  let nextHeadPos = { x: 9, y: 9 };
  let touchStartX = null;
  let touchStartY = null;
  const minSwipeDist = 30;

  // Focus management helper
  function trapFocus(container) {
    const focusableElementsString = 'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]';
    let focusableElements = container.querySelectorAll(focusableElementsString);
    focusableElements = Array.prototype.slice.call(focusableElements);

    if(focusableElements.length === 0) return;

    let firstTabStop = focusableElements[0];
    let lastTabStop = focusableElements[focusableElements.length - 1];

    container.addEventListener('keydown', function(e) {
      if (e.key === 'Tab' || e.keyCode === 9) {
        if (e.shiftKey) { // Shift + Tab
          if (document.activeElement === firstTabStop) {
            e.preventDefault();
            lastTabStop.focus();
          }
        } else { // Tab
          if (document.activeElement === lastTabStop) {
            e.preventDefault();
            firstTabStop.focus();
          }
        }
      }
    });
  }

  // Update leaderboard UI function
  function updateLeaderboard() {
    leaderboardList.innerHTML = '';
    const li = document.createElement('li');
    li.textContent = playerName + ': ' + highestScore;
    leaderboardList.appendChild(li);
  }

  // Color selection for skin
  let selectedSkinColor = playerSkinColor;
  function renderSkinColors() {
    changeSkinDiv.innerHTML = '';
    colors.forEach(color => {
      const colorOption = document.createElement('div');
      colorOption.classList.add('color-option');
      colorOption.style.backgroundColor = color;
      if(color === selectedSkinColor) colorOption.classList.add('selected');
      colorOption.addEventListener('click', () => {
        selectedSkinColor = color;
        playerSkinColor = color;
        localStorage.setItem('snakeSkinColor', playerSkinColor);
        document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
        colorOption.classList.add('selected');
      });
      changeSkinDiv.appendChild(colorOption);
    });
  }

  // Show name popup if name not set
  if(!playerName) {
    namePopup.classList.remove('hidden');
    startPage.classList.remove('visible');
    gameContainer.setAttribute('aria-hidden', 'true');
    trapFocus(namePopup);
  } else {
    namePopup.classList.add('hidden');
    startPage.classList.add('visible');
    gameContainer.setAttribute('aria-hidden', 'true');
  }

  // Name input submit
  submitNameBtn.addEventListener('click', () => {
    const val = nameInput.value.trim();
    if(val.length === 0) {
      alert('Please enter a name');
      nameInput.focus();
      return;
    }
    playerName = val;
    localStorage.setItem('snakePlayerName', playerName);
    namePopup.classList.add('hidden');
    startPage.classList.add('visible');
    gameContainer.setAttribute('aria-hidden', 'true');
    trapFocus(startPage);
  });

  // Start game button
  startBtn.addEventListener('click', () => {
    startPage.classList.remove('visible');
    gameContainer.setAttribute('aria-hidden', 'false');
    resetGame();
    gameLoop();
    canvas.focus();
  });

  // Leaderboard button
  leaderboardBtn.addEventListener('click', () => {
    updateLeaderboard();
    startPage.classList.remove('visible');
    leaderboard.classList.add('visible');
    leaderboard.setAttribute('aria-hidden', 'false');
    trapFocus(leaderboard);
  });

  // Close leaderboard
  closeLeaderboardBtn.addEventListener('click', () => {
    leaderboard.classList.remove('visible');
    leaderboard.setAttribute('aria-hidden', 'true');
    startPage.classList.add('visible');
    trapFocus(startPage);
  });

  // Settings button
  settingsBtn.addEventListener('click', () => {
    nameChangeInput.value = playerName;
    renderSkinColors();
    startPage.classList.remove('visible');
    settings.classList.add('visible');
    settings.setAttribute('aria-hidden', 'false');
    trapFocus(settings);
  });

  // Change name button
  changeNameBtn.addEventListener('click', () => {
    const newName = nameChangeInput.value.trim();
    if(newName.length === 0) {
      alert('Name cannot be empty');
      return;
    }
    playerName = newName;
    localStorage.setItem('snakePlayerName', playerName);
    alert('Name changed to: ' + playerName);
  });

  // Close settings button
  closeSettingsBtn.addEventListener('click', () => {
    settings.classList.remove('visible');
    settings.setAttribute('aria-hidden', 'true');
    startPage.classList.add('visible');
    trapFocus(startPage);
  });

  // Back to menu button functionality
  backToMenuBtn.addEventListener('click', () => {
    // Stop game loop by setting gameOver state
    gameOver = true;
    // Hide game container, show start page
    gameContainer.setAttribute('aria-hidden', 'true');
    startPage.classList.add('visible');
    trapFocus(startPage);
  });

  // Helper functions for game logic
  function randomPosition() {
    return {
      x: Math.floor(Math.random() * COLS),
      y: Math.floor(Math.random() * ROWS)
    };
  }

  function positionsEqual(pos1, pos2) {
    return pos1.x === pos2.x && pos1.y === pos2.y;
  }

  function placeFood() {
    let newPos;
    do {
      newPos = randomPosition();
    } while (snake.some(segment => positionsEqual(segment, newPos)));
    food = newPos;
  }

  function resetGame() {
    snake = [{x:9, y:9}];
    direction = DIRS.RIGHT;
    nextDirection = direction;
    score = 0;
    speedLevel = 1;
    speed = 5;
    gameOver = false;
    paused = false;
    lastMoveTime = 0;
    moveProgress = 0;
    lastHeadPos = { x: 9, y: 9 };
    nextHeadPos = { x: 9, y: 9 };
    placeFood();
    scoreEl.textContent = score;
    speedEl.textContent = speedLevel;
    gameOverScreen.classList.remove('visible');
    pauseIndicator.style.display = 'none';
    canvas.focus();
  }

  // Draw functions
  function lerp(start, end, t) {
    return start + (end - start) * t;
  }

  function interpPos(startPos, endPos, t) {
    return {
      x: lerp(startPos.x, endPos.x, t),
      y: lerp(startPos.y, endPos.y, t)
    };
  }

  function drawCell(x, y, color, radius=0) {
    const px = x * CELL_SIZE;
    const py = y * CELL_SIZE;
    ctx.fillStyle = color;
    const r = radius > 0 ? radius : CELL_SIZE / 2 * 0.9;
    ctx.beginPath();
    if(radius > 0) {
      ctx.moveTo(px + r, py);
      ctx.arc(px + r, py + r, r, -Math.PI/2, Math.PI/2, false);
      ctx.lineTo(px + r * 2, py + CELL_SIZE - r);
      ctx.arc(px + r, py + CELL_SIZE - r, r, Math.PI/2, 3*Math.PI/2, false);
      ctx.closePath();
    } else {
      ctx.arc(px + CELL_SIZE/2, py + CELL_SIZE/2, CELL_SIZE/2 * 0.9, 0, 2 * Math.PI);
    }
    ctx.fill();
  }

  function drawSnake(t) {
    let interpSegments = [];
    if(snake.length === 1) {
      let pos = interpPos(lastHeadPos, nextHeadPos, moveProgress);
      interpSegments.push(pos);
    } else {
      let headInterp = interpPos(lastHeadPos, nextHeadPos, moveProgress);
      interpSegments[snake.length - 1] = headInterp;
      for(let i = snake.length - 2; i >= 0; i--) {
        let currentPos = snake[i];
        let nextPos = snake[i + 1];
        interpSegments[i] = interpPos(currentPos, nextPos, moveProgress);
      }
    }
    ctx.shadowColor = '#2f74e3cc';
    ctx.shadowBlur = 6;

    for(let i = 0; i < interpSegments.length; i++) {
      let pos = interpSegments[i];
      if(i === interpSegments.length - 1) {
        drawCell(pos.x, pos.y, '#f0f8ff', CELL_SIZE * 0.4);
        ctx.fillStyle = playerSkinColor;
        drawCell(pos.x, pos.y, playerSkinColor);
      } else {
        ctx.fillStyle = playerSkinColor;
        drawCell(pos.x, pos.y, playerSkinColor);
      }
    }
    ctx.shadowBlur = 0;
  }

  function drawFood(t) {
    const pulse = Math.sin(t / 300) * 0.3 + 1;
    ctx.shadowColor = '#ff6d4c';
    ctx.shadowBlur = 15 * pulse;
    drawCell(food.x, food.y, `rgba(255,111,76,${0.7 + 0.3 * pulse})`, CELL_SIZE * 0.5);
    ctx.shadowBlur = 0;
  }

  function update() {
    if (gameOver || paused) return;

    let now = performance.now();
    let timeSinceMove = now - lastMoveTime;
    if (timeSinceMove < 1000 / speed) return;

    lastMoveTime = now;
    moveProgress = 0;

    if ((nextDirection.x !== -direction.x || nextDirection.y !== -direction.y) && (nextDirection.x !== 0 || nextDirection.y !== 0)) {
      direction = nextDirection;
    }

    let head = snake[snake.length - 1];
    lastHeadPos = {...head};
    let newHead = { x: head.x + direction.x, y: head.y + direction.y };

    if (newHead.x < 0) newHead.x = COLS - 1;
    else if (newHead.x >= COLS) newHead.x = 0;
    if (newHead.y < 0) newHead.y = ROWS - 1;
    else if (newHead.y >= ROWS) newHead.y = 0;

    nextHeadPos = {...newHead};

    if (snake.some(seg => positionsEqual(seg, newHead))) {
      endGame();
      return;
    }

    snake.push(newHead);

    if (positionsEqual(newHead, food)) {
      score++;
      if(score > highestScore){
        highestScore = score;
        localStorage.setItem('snakeHighestScore', highestScore);
      }
      scoreEl.textContent = score;

      if (score % speedIncrementScoreStep === 0 && speedLevel < maxSpeedLevel) {
        speedLevel++;
        speed += 2;
        speedEl.textContent = speedLevel;
      }

      placeFood();
    } else {
      snake.shift();
    }
  }

  function draw(t) {
    if (!gameOver && !paused) {
      let now = performance.now();
      let elapsed = now - lastMoveTime;
      let frameTime = 1000 / speed;
      moveProgress = Math.min(elapsed / frameTime, 1);
    }

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = 'rgba(255, 255, 255, 0.04)';
    ctx.lineWidth = 1;
    for(let i = 0; i <= COLS; i++) {
      ctx.beginPath();
      ctx.moveTo(i * CELL_SIZE, 0);
      ctx.lineTo(i * CELL_SIZE, canvas.height);
      ctx.stroke();
    }
    for(let j = 0; j <= ROWS; j++) {
      ctx.beginPath();
      ctx.moveTo(0, j * CELL_SIZE);
      ctx.lineTo(canvas.width, j * CELL_SIZE);
      ctx.stroke();
    }

    drawFood(t);
    drawSnake(t);

    if (paused) {
      pauseIndicator.style.display = 'block';
    } else {
      pauseIndicator.style.display = 'none';
    }
  }

  function gameLoop(t = 0) {
    update();
    draw(t);
    if(!gameOver) window.requestAnimationFrame(gameLoop);
  }

  window.addEventListener('keydown', e => {
    if (gameOver) return;
    switch(e.key) {
      case 'ArrowUp': case 'w': case 'W':
        if(direction !== DIRS.DOWN) nextDirection = DIRS.UP; break;
      case 'ArrowDown': case 's': case 'S':
        if(direction !== DIRS.UP) nextDirection = DIRS.DOWN; break;
      case 'ArrowLeft': case 'a': case 'A':
        if(direction !== DIRS.RIGHT) nextDirection = DIRS.LEFT; break;
      case 'ArrowRight': case 'd': case 'D':
        if(direction !== DIRS.LEFT) nextDirection = DIRS.RIGHT; break;
      case ' ':
      case 'Spacebar':
        togglePause();
        break;
    }
  });

  canvas.addEventListener('touchstart', e => {
    if(e.touches.length === 1) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }
  });

  canvas.addEventListener('touchend', e => {
    if(gameOver) return;
    if(touchStartX === null || touchStartY === null) return;
    let touchEndX = e.changedTouches[0].clientX;
    let touchEndY = e.changedTouches[0].clientY;
    let dx = touchEndX - touchStartX;
    let dy = touchEndY - touchStartY;
    if(Math.abs(dx) > Math.abs(dy)) {
      if(dx > minSwipeDist && direction !== DIRS.LEFT) nextDirection = DIRS.RIGHT;
      else if(dx < -minSwipeDist && direction !== DIRS.RIGHT) nextDirection = DIRS.LEFT;
    } else {
      if(dy > minSwipeDist && direction !== DIRS.UP) nextDirection = DIRS.DOWN;
      else if(dy < -minSwipeDist && direction !== DIRS.DOWN) nextDirection = DIRS.UP;
    }
    touchStartX = null;
    touchStartY = null;
  });

  function togglePause() {
    if(gameOver) return;
    paused = !paused;
    if(!paused) {
      lastMoveTime = performance.now();
    }
  }

  function endGame() {
    gameOver = true;
    gameOverScore.textContent = "Your Score: " + score;
    gameOverScreen.classList.add('visible');
  }

  restartBtn.addEventListener('click', () => {
    resetGame();
  });

  // Back to menu button functionality
  backToMenuBtn.addEventListener('click', () => {
    // Stop game loop by setting gameOver state
    gameOver = true;
    // Hide game container, show start page
    gameContainer.setAttribute('aria-hidden', 'true');
    startPage.classList.add('visible');
    trapFocus(startPage);
  });

  // If previously opened, do not show game immediately
  if(playerName) {
    // Show start page with hidden game container
    startPage.classList.add('visible');
    gameContainer.setAttribute('aria-hidden', 'true');
  } else {
    // Show name popup
    namePopup.classList.remove('hidden');
    startPage.classList.remove('visible');
    gameContainer.setAttribute('aria-hidden', 'true');
  }

})();
</script>
</body>
</html>

